<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resumen Diario de Asistencias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
        }

        .badge-danger {
            background-color: #dc3545;
        }

        .badge-warning {
            background-color: #ffc107;
        }

        .badge-success {
            background-color: #28a745;
        }
    </style>
</head>

<body>
    <div class="container">
        <h3 class="mb-4" id="tituloResumen">üìä Resumen Diario de Asistencias</h3>
        <div class="mb-3 d-flex align-items-end gap-2">
            <input type="date" id="fechaSeleccionada" class="form-control w-auto">
            <button class="btn btn-primary" onclick="cargarResumen()">üîÑ Ver resumen</button>
            <button class="btn btn-success" id="btnExportar" onclick="exportarExcel()">üìÅ Exportar a Excel</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tablaResumen">
                <thead class="table-dark">
                    <tr>
                        <th class="th-legajo">Legajo</th>
                        <th class="th-apellido">Apellido</th>
                        <th class="th-nombre">Nombre</th>
                        <th class="th-sector">Sector</th>
                        <th>Esperado</th>
                        <th>Ingreso</th>
                        <th>Egreso</th>
                        <th>Horas</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="tbodyResumen"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC4v9h8eXWRBnzTD-VDDludynd5nzOv4xc",
            authDomain: "est-utn-c0988.firebaseapp.com",
            projectId: "est-utn-c0988",
            storageBucket: "est-utn-c0988.firebasestorage.app",
            messagingSenderId: "788767016042",
            appId: "1:788767016042:web:8a480a74e3b1ef0de97613"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let usuarioActual = null;

        auth.onAuthStateChanged(async user => {
            if (!user) window.location.href = "login.html";
            const doc = await db.collection("usuarios").doc(user.uid).get();
            if (!doc.exists) {
                alert("‚ùå Usuario no registrado");
                window.location.href = "menu.html";
            }

            usuarioActual = doc.data();

            const hoy = new Date().toISOString().split("T")[0];
            document.getElementById("fechaSeleccionada").value = hoy;

            if (usuarioActual.rol !== "admin") {
                const nombreCompleto = `${usuarioActual.nombre} ${usuarioActual.apellido}`;
                const sector = usuarioActual.sector || "";
                const legajo = usuarioActual.legajo || "";
                document.getElementById("tituloResumen").innerText = `üìä Resumen de ${nombreCompleto} ‚Äì ${sector} (Legajo: ${legajo})`;

                // Ocultar columnas innecesarias
                document.querySelectorAll(".th-legajo, .th-apellido, .th-nombre, .th-sector")
                    .forEach(th => th.remove());
            }

            cargarResumen();
        });

        async function cargarResumen() {
            const fecha = document.getElementById("fechaSeleccionada").value;
            const tbody = document.getElementById("tbodyResumen");
            tbody.innerHTML = "";

            const asistenciasSnap = await db.collection("asistencias")
                .where("fecha", "==", fecha).get();

            const asistencias = {};
            asistenciasSnap.forEach(doc => asistencias[doc.data().legajo] = doc.data());

            let usuariosSnap;

            if (usuarioActual.rol === "admin") {
                usuariosSnap = await db.collection("usuarios").get();
            } else {
                usuariosSnap = [{ data: () => usuarioActual }];
            }

            usuariosSnap.forEach(doc => {
                const u = typeof doc.data === "function" ? doc.data() : doc;
                const a = asistencias[u.legajo];
                const diaSemana = new Date(fecha).toLocaleDateString("es-AR", { weekday: 'long' });
                const esperado = u.horarios?.[capitalizar(diaSemana)] || null;
                const ingreso = a?.ingreso?.hora || "-";
                const egreso = a?.egreso?.hora || "-";
                const horas = a?.horasTrabajadas?.toFixed(2) || "-";
                let estado = "Ausente";

                if (a && esperado) {
                    const t1 = esperado.entrada;
                    const t2 = esperado.salida;
                    const llegoTarde = ingreso > t1;
                    const salioAntes = egreso < t2;
                    const cumpleHoras = a.horasTrabajadas >= calcularHoras(t1, t2);

                    if (!ingreso || !egreso) estado = "Incompleto";
                    else if (llegoTarde || salioAntes) estado = "Parcial";
                    else if (cumpleHoras) estado = "‚úîÔ∏è OK";
                }

                const badge = estado === "‚úîÔ∏è OK" ? "success" : estado === "Ausente" ? "danger" : "warning";
                const esperadaTxt = esperado ? `${esperado.entrada} - ${esperado.salida}` : "-";

                tbody.innerHTML += `
                    <tr>
                        ${usuarioActual.rol === "admin" ? `
                        <td>${u.legajo}</td>
                        <td>${u.apellido}</td>
                        <td>${u.nombre}</td>
                        <td>${u.sector}</td>
                        ` : ""}
                        <td>${esperadaTxt}</td>
                        <td>${ingreso}</td>
                        <td>${egreso}</td>
                        <td>${horas}</td>
                        <td><span class="badge bg-${badge}">${estado}</span></td>
                    </tr>`;
            });
        }

        function capitalizar(palabra) {
            return palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase();
        }

        function calcularHoras(inicio, fin) {
            const [h1, m1] = inicio.split(":").map(Number);
            const [h2, m2] = fin.split(":").map(Number);
            return ((h2 * 60 + m2) - (h1 * 60 + m1)) / 60;
        }

        function exportarExcel() {
            const tabla = document.getElementById("tablaResumen");
            const wb = XLSX.utils.table_to_book(tabla, { sheet: "Resumen" });
            XLSX.writeFile(wb, "resumen_diario.xlsx");
        }
    </script>
</body>

</html>